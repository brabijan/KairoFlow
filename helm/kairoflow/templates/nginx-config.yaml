apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kairoflow.fullname" . }}-nginx-config
  labels:
    {{- include "kairoflow.labels" . | nindent 4 }}
data:
  nginx.conf: |
    user nginx;
    worker_processes {{ .Values.nginx.workerProcesses }};
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections {{ .Values.nginx.workerConnections }};
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript 
                   application/json application/javascript application/xml+rss 
                   application/rss+xml application/atom+xml image/svg+xml 
                   text/x-js text/x-cross-domain-policy application/x-font-ttf 
                   application/x-font-opentype application/vnd.ms-fontobject 
                   image/x-icon;

        # Client body size
        client_max_body_size {{ .Values.nginx.clientMaxBodySize }};
        client_body_buffer_size 128k;

        # Proxy timeouts
        proxy_connect_timeout {{ .Values.nginx.proxyConnectTimeout }};
        proxy_send_timeout {{ .Values.nginx.proxySendTimeout }};
        proxy_read_timeout {{ .Values.nginx.proxyReadTimeout }};
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;

        # FastCGI timeouts
        fastcgi_connect_timeout {{ .Values.nginx.proxyConnectTimeout }};
        fastcgi_send_timeout {{ .Values.nginx.proxySendTimeout }};
        fastcgi_read_timeout {{ .Values.nginx.proxyReadTimeout }};
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;

        include /etc/nginx/conf.d/*.conf;
    }

  default.conf: |
    server {
        listen 80;
        listen [::]:80;
        server_name _;

        root /var/www/html/public;
        index index.php index.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # Health check endpoint
        location /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "OK";
        }

        # Static files
        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml|svg|woff|woff2|ttf|eot)$ {
            access_log off;
            log_not_found off;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # Uploads directory
        location /uploads {
            alias /var/www/html/public/uploads;
            expires 30d;
            add_header Cache-Control "public";
        }

        # PHP processing
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_param SERVER_NAME $host;
            
            # FastCGI buffering
            fastcgi_buffering on;
            fastcgi_buffer_size 128k;
            fastcgi_buffers 256 16k;
            fastcgi_busy_buffers_size 256k;
            
            # Timeouts
            fastcgi_connect_timeout {{ .Values.nginx.proxyConnectTimeout }};
            fastcgi_send_timeout {{ .Values.nginx.proxySendTimeout }};
            fastcgi_read_timeout {{ .Values.nginx.proxyReadTimeout }};
        }

        # Deny access to sensitive files
        location ~ /\.(ht|git|svn) {
            deny all;
        }

        location ~ ^/(app|bin|config|migrations|temp|tests|vendor)/ {
            deny all;
        }

        location ~ \.(neon|ini|log|yml|yaml)$ {
            deny all;
        }
    }