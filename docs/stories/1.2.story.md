# Epic 1 - Story 1.2: Kubernetes Deployment Configuration

## Epic Reference
Epic 1: Project Foundation & Authentication

## Priority
P0 (Critical - Foundation)

## Status
Ready for Review

## Story
**As a** DevOps engineer,
**I want** to create Helm charts for the application,
**so that** I can deploy to the Rancher cluster reliably

## Acceptance Criteria
1. Helm chart created with configurable values.yaml
2. Deployment includes app container, PostgreSQL, and Redis
3. Ingress configured with HTTPS termination
4. Persistent volumes for database and file storage
5. Liveness and readiness probes configured to /health
6. Secrets management for sensitive configurations
7. Successfully deploys to K8s namespace

## Tasks / Subtasks
- [x] Create Helm chart structure (AC: 1)
  - [x] Initialize Helm chart directory at `helm/kairoflow/`
  - [x] Create Chart.yaml with chart metadata (version 0.1.0, appVersion 1.0.0)
  - [x] Create values.yaml with configurable parameters
  - [x] Create templates directory structure
- [x] Configure application deployment (AC: 2, 5)
  - [x] Create web-app-deployment.yaml template with two-container pod pattern
  - [x] Configure nginx container (custom image from ghcr.io)
    - [x] Use image: ghcr.io/${{ github.repository }}/nginx:latest
    - [x] Mount nginx-config ConfigMap for nginx.conf and default.conf
    - [x] Proxy PHP requests to 127.0.0.1:9000
    - [x] Serve static files from /var/www/html/www/
    - [x] Configure client_max_body_size: 500M for large uploads
  - [x] Configure php-fpm container (custom image from ghcr.io)
    - [x] Use image: ghcr.io/${{ github.repository }}/php:latest
    - [x] Configure environment variables from secrets (database, Redis, MinIO, OpenAI)
    - [x] Add postStart lifecycle hook: `php bin/console migrations:migrate --no-interaction --allow-no-migration`
    - [x] Mount shared volumes: uploads, sessions, recordings, transcriptions
    - [x] Set PHP limits: memory_limit=512M, max_execution_time=600
  - [x] Set resource requests and limits for both containers
  - [x] Configure ServiceAccount with imagePullSecrets for GHCR
  - [x] Add nodeSelector if needed (kubernetes.io/hostname)
- [x] Configure external database connection (AC: 2, 6)
  - [x] Create database-secret.yaml template with placeholders
  - [x] Configure DATABASE_HOST, DATABASE_USER, DATABASE_PASSWORD, DATABASE_NAME, DATABASE_PORT
  - [x] Document external PostgreSQL service requirements in README
  - [x] Add secret creation instructions to deployment docs
- [x] Configure external Redis connection (AC: 2, 6)
  - [x] Create redis-secret.yaml template with placeholders
  - [x] Configure REDIS_HOST, REDIS_PORT, REDIS_PASSWORD (optional)
  - [x] Document external Redis service requirements in README
  - [x] Add Redis secret creation instructions to deployment docs
- [x] Configure MinIO/S3 storage connection (AC: 2, 6)
  - [x] Create minio-secret.yaml template
  - [x] Configure MINIO_ENDPOINT, MINIO_ACCESS_KEY, MINIO_SECRET_KEY
  - [x] Document S3-compatible storage requirements
  - [x] Add MinIO secret creation instructions
- [x] Configure Traefik IngressRoute (AC: 3)
  - [x] Create ingressroute.yaml template for Traefik CRD
  - [x] Configure HTTPS termination with cert-manager Certificate resource
  - [x] Set up routing rules with Host matching for KairoFlow
  - [x] Create HTTP to HTTPS redirect middleware
  - [x] Configure entryPoints: web (80) and websecure (443)
- [x] Implement secrets management (AC: 6)
  - [x] Create database-secret.yaml template
  - [x] Create redis-secret.yaml template  
  - [x] Create minio-secret.yaml template
  - [x] Create openai-secret.yaml template (OPENAI_API_KEY)
  - [x] Create app-secret.yaml template (APP_SECRET, JWT_SECRET)
  - [x] Create ghcr-secret.yaml for container registry auth
  - [x] Document secret creation process in README:
    - [x] kubectl create secret commands
    - [x] Required values for each secret
    - [x] Security best practices
- [x] Configure persistent volumes (AC: 4)
  - [x] Create pvc-uploads.yaml for file uploads (5Gi)
  - [x] Create pvc-sessions.yaml for PHP sessions (2Gi)
  - [x] Create pvc-recordings.yaml for audio recordings (10Gi)
  - [x] Create pvc-transcriptions.yaml for transcriptions (5Gi)
  - [x] Mount volumes in both nginx and php containers:
    - [x] /var/www/html/www/uploads (uploads PVC)
    - [x] /var/www/html/var/tmp/session (sessions PVC)
    - [x] /var/www/html/var/tmp/recordings (recordings PVC)
    - [x] /var/www/html/var/tmp/transcriptions (transcriptions PVC)
  - [x] Use emptyDir for /var/www/html/var/log (logs)
  - [x] Configure storage class annotations if needed
- [x] Create service definitions (AC: 2, 5)
  - [x] Create web-app-service.yaml for KairoFlow app (ClusterIP, port 80)
  - [x] Configure service selector: app: web-app
  - [x] No internal PostgreSQL/Redis services (using external managed services)
- [x] Add CronJob configurations (AC: 2)
  - [x] Create cronjob-email-processor.yaml template
  - [x] Schedule: "*/1 * * * *" (every minute)
  - [x] Command: ["php", "bin/console", "app:email:process"]
  - [x] Set concurrencyPolicy: Forbid
  - [x] Configure activeDeadlineSeconds: 50
  - [x] Add resource limits (128Mi request, 256Mi limit)
- [x] Create nginx ConfigMap (AC: 2)
  - [x] Create nginx-config.yaml template
  - [x] Define nginx.conf with global settings:
    - [x] client_max_body_size: 500M
    - [x] Extended timeouts: 600s
    - [x] Worker processes and connections
  - [x] Define default.conf with:
    - [x] PHP upstream: 127.0.0.1:9000
    - [x] Document root: /var/www/html/www/
    - [x] PHP-FPM proxy configuration
    - [x] Static file serving rules
- [x] Configure namespace and RBAC (AC: 7)
  - [x] Create namespace.yaml template
  - [x] Add namespace: kairoflow
  - [x] Create service-account.yaml with default ServiceAccount
  - [x] Configure imagePullSecrets for GHCR in ServiceAccount
  - [x] Create ghcr-secret.yaml template for GitHub Container Registry
  - [x] Add instructions for creating GHCR token with read:packages scope
- [x] Create Helm values configuration (AC: 1)
  - [x] Define image repository and tag values
  - [x] Configure replica counts
  - [x] Set resource limits as configurable values
  - [x] Define ingress host and TLS settings
  - [x] Configure database and Redis connection parameters
  - [x] Add environment-specific overrides (dev, staging, prod)
- [x] Write deployment documentation (AC: 7)
  - [x] Create helm/kairoflow/README.md
  - [x] Document Helm installation commands
  - [x] Document upgrade and rollback procedures
  - [x] List all configurable values
  - [x] Add troubleshooting section
  - [x] Include secret management instructions
- [x] Test Helm chart locally (AC: 7)
  - [x] Validate chart syntax: `helm lint helm/kairoflow`
  - [x] Generate manifests: `helm template kairoflow helm/kairoflow`
  - [x] Test installation with dry-run: `helm install kairoflow helm/kairoflow --dry-run`
  - [x] Document test results

## Tasks / Subtasks - CI/CD Pipeline
- [x] Create GitHub Actions workflow (AC: 7)
  - [x] Create .github/workflows/docker-build.yml
  - [x] Configure workflow triggers:
    - [x] Push to master branch
    - [x] Pull requests to master
    - [x] Manual workflow_dispatch
  - [x] Set up build job for Docker images:
    - [x] Build PHP image from docker/php/Dockerfile
    - [x] Build Nginx image from docker/nginx/Dockerfile
    - [x] Push to GitHub Container Registry (ghcr.io)
    - [x] Tag with latest and commit SHA
  - [x] Set up deployment job:
    - [x] Configure kubectl with KUBECONFIG secret
    - [x] Apply Kubernetes manifests in order
    - [x] Perform rollout restart after deployment
  - [x] Set up infrastructure job:
    - [x] Create/update GHCR secret in cluster
    - [x] Create/update application secrets
    - [x] Apply PVCs and other resources
  - [x] Configure GitHub secrets:
    - [x] KUBECONFIG (base64 encoded kubeconfig)
    - [x] CR_PAT or use GITHUB_TOKEN
    - [x] DATABASE_HOST, DATABASE_USER, DATABASE_PASSWORD, DATABASE_NAME
    - [x] REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
    - [x] MINIO_ENDPOINT, MINIO_ACCESS_KEY, MINIO_SECRET_KEY
    - [x] OPENAI_API_KEY

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 - Project Setup & Repository Initialization]
- Health check endpoint will be available at /health returning 200 OK with system status
- Application uses Nette Framework with PHP 8.4+
- Database configuration uses environment variables: DATABASE_DSN, DATABASE_USER, DATABASE_PASSWORD
- Redis configuration uses: REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
- Docker base image: php:8.4-fpm-alpine with required extensions

### Docker Build Configuration
[Source: terap.online Dockerfiles]

**PHP Dockerfile (.docker/php/Dockerfile):**
- Base: php:8.3-fpm (production stage)
- Install required extensions: pdo_pgsql, pgsql, intl, zip, gd
- Configure PHP limits: memory_limit=512M, upload_max_filesize=100M
- Run as www-data user (UID/GID 1000)
- Install composer dependencies
- Generate Doctrine proxies at build time
- Create required directories with proper permissions

**Nginx Dockerfile (.docker/nginx/Dockerfile):**
- Base: nginx:alpine
- Copy custom nginx.conf and site configuration
- Configure for PHP-FPM upstream on port 9000
- Set client_max_body_size to 500M for large uploads

### Cluster-Specific Configuration from terap.online
[Source: terap.online K8s manifests]

**IMPORTANT: This cluster uses Traefik IngressRoute instead of standard Ingress!**

The Rancher cluster at infra.terap.online has specific requirements:
- Uses Traefik as ingress controller (NOT nginx-ingress)
- Requires IngressRoute CRD instead of standard Ingress
- Uses cert-manager with letsencrypt-prod ClusterIssuer
- Node selector capability: `kubernetes.io/hostname`
- Uses GHCR (GitHub Container Registry) with imagePullSecrets

**Deployment Pattern (from terap.online):**
- Separate nginx and php-fpm containers in same pod
- Nginx serves static files, proxies to php-fpm on port 9000
- ConfigMap for nginx configuration
- Lifecycle hooks for migrations: `postStart` command
- Multiple PVCs for different data types (uploads, sessions, etc.)

### Kubernetes Architecture
[Source: architecture/6-kubernetes-deployment.md + terap.online patterns]

**Deployment Strategy:**
- Namespace: kairoflow
- Replica count: 1 initially (can scale to 2 later)
- No specific rolling update needed for single replica
- Resource requests: 256Mi memory, 250m CPU
- Resource limits: 512Mi memory, 500m CPU

**Container Architecture (following terap.online pattern):**
- Two containers per pod: nginx + php-fpm
- Nginx container: serves static, proxies PHP to localhost:9000
- PHP container: runs php-fpm, handles migrations on startup

**Health Checks:**
- Liveness probe: HTTP GET /health on nginx container, initialDelay: 30s, period: 10s
- Readiness probe: HTTP GET /health on nginx container, initialDelay: 5s, period: 5s

**CronJob Configuration:**
- Email processor runs every minute
- ConcurrencyPolicy: Forbid (prevent overlapping runs)
- ActiveDeadlineSeconds: 50 (kill if runs > 50 seconds)
- Command: ["php", "bin/console", "app:email:process"]

### Helm Chart Structure
[Source: terap.online K8s manifests organization]

Expected Helm chart location:
```
helm/
└── kairoflow/
    ├── Chart.yaml
    ├── values.yaml
    ├── values.dev.yaml              # Development overrides
    ├── values.prod.yaml             # Production overrides
    ├── templates/
    │   ├── namespace.yaml
    │   ├── web-app-deployment.yaml  # Two-container pod (nginx + php-fpm)
    │   ├── web-app-service.yaml
    │   ├── ingressroute.yaml        # Traefik IngressRoute CRD
    │   ├── certificate.yaml         # cert-manager Certificate
    │   ├── nginx-config.yaml        # Nginx ConfigMap
    │   ├── service-account.yaml     # ServiceAccount with imagePullSecrets
    │   ├── ghcr-secret.yaml         # GitHub Container Registry auth
    │   ├── database-secret.yaml     # External DB credentials
    │   ├── redis-secret.yaml        # External Redis credentials
    │   ├── minio-secret.yaml        # S3/MinIO credentials
    │   ├── openai-secret.yaml       # OpenAI API key
    │   ├── app-secret.yaml          # Application secrets
    │   ├── pvc-uploads.yaml         # User uploads storage
    │   ├── pvc-sessions.yaml        # PHP sessions storage
    │   ├── pvc-recordings.yaml      # Audio recordings storage
    │   ├── pvc-transcriptions.yaml  # Transcriptions storage
    │   └── cronjob-email-processor.yaml
    └── README.md
```

### Container Configuration
[Source: terap.online Dockerfiles]

**Kubernetes & Helm:**
- Kubernetes 1.28+ with Helm 3.x
- Rancher 2 for K8s management
- Custom Docker images built via GitHub Actions
- PHP base image: php:8.3-fpm (production stage)
- Nginx base image: nginx:alpine

**Required PHP Extensions (from terap.online):**
- pdo_pgsql (PostgreSQL)
- pgsql (PostgreSQL native)
- intl (Internationalization)
- zip (Archive handling)
- gd (Image processing with JPEG/FreeType support)
- Standard FPM extensions

### Environment Variables
[Source: terap.online deployment configuration]

Required environment variables for deployment:

**Database Configuration:**
- DATABASE_HOST (external PostgreSQL host)
- DATABASE_USER (database username)
- DATABASE_PASSWORD (database password)
- DATABASE_NAME (database name)
- DATABASE_PORT (optional, default: 5432)

**Redis Configuration:**
- REDIS_HOST (external Redis host)
- REDIS_PORT (default: 6379)
- REDIS_PASSWORD (optional, if Redis auth enabled)

**Object Storage (MinIO/S3):**
- MINIO_ENDPOINT (S3-compatible endpoint)
- MINIO_ACCESS_KEY (access key)
- MINIO_SECRET_KEY (secret key)
- MINIO_USE_SSL (true for HTTPS)

**Application Configuration:**
- NETTE_ENV (prod for production)
- NETTE_DEBUG (0 for production)
- APP_SECRET (Nette application secret)
- JWT_SECRET (for JWT token generation)
- OPENAI_API_KEY (for AI features)

**PHP Configuration (set in deployment):**
- PHP_MAX_EXECUTION_TIME (600)
- PHP_MEMORY_LIMIT (512M)
- PHP_POST_MAX_SIZE (500M)
- PHP_UPLOAD_MAX_FILESIZE (500M)

### Service Configuration
[Source: terap.online deployment patterns]

**PostgreSQL Service:**
- External managed service (not deployed in K8s)
- Connection via secrets: DATABASE_HOST, DATABASE_USER, DATABASE_PASSWORD, DATABASE_NAME, DATABASE_PORT
- Recommended: Managed PostgreSQL service from cloud provider

**Redis Service:**
- External managed service (not deployed in K8s)
- Connection via secrets: REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
- Recommended: Managed Redis service from cloud provider

**MinIO/S3 Service:**
- External object storage service
- Connection via secrets: MINIO_ENDPOINT, MINIO_ACCESS_KEY, MINIO_SECRET_KEY
- Used for file storage and CDN

**Application Service:**
- Two-container pod: nginx (port 80) + php-fpm (port 9000)
- Type: ClusterIP
- Exposed via Traefik IngressRoute
- ServiceAccount with imagePullSecrets for GHCR

### Security Considerations
[Source: architecture/7-security-architecture.md]

**Secret Management:**
- Use Kubernetes Secrets for sensitive data
- Never hardcode credentials in manifests
- Document secret creation process
- Consider using sealed-secrets or external-secrets-operator

**Network Security:**
- HTTPS termination at Ingress
- Security headers via Ingress annotations
- Rate limiting configuration
- Internal services use ClusterIP

### File Storage
[Source: architecture/source-tree.md#public-assets]

**Persistent Volume Mounts:**
- /app/public/uploads - User uploads (5Gi)
  - /app/public/uploads/qr-codes - Generated QR codes
  - /app/public/uploads/attachments - Email attachments

### Performance Targets
[Source: architecture/tech-stack.md#performance-targets]

- Page Load: < 2 seconds (95th percentile)
- API Response: < 200ms (average)
- Email Processing: < 30 seconds per email
- Health check response: < 100ms

### Deployment Commands Reference
[Source: architecture/tech-stack.md]

Console commands to be used in CronJobs:
- `bin/console app:email:process` - Process emails (every minute)
- `bin/console app:invoice:generate` - Generate invoices (weekly)
- `bin/console app:cleanup` - Cleanup old data (daily)
- `bin/console orm:schema:validate` - Validate schema (daily check)

### Traefik IngressRoute Example
[Source: terap.online/k8s/ingress.yaml]

Example IngressRoute configuration for this cluster:
```yaml
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: kairoflow-https
  namespace: kairoflow
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`kairoflow.example.com`)
      kind: Rule
      services:
        - name: kairoflow-web
          port: 80
  tls:
    secretName: kairoflow-tls
```

### Certificate Configuration
[Source: terap.online/k8s/certificate.yaml]

cert-manager Certificate for TLS:
```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: kairoflow-tls
  namespace: kairoflow
spec:
  secretName: kairoflow-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - kairoflow.example.com
```

## Testing
[Source: architecture/coding-standards.md#testing-standards]

### Helm Chart Testing
1. **Syntax Validation**
   - Run: `helm lint helm/kairoflow`
   - Expected: No errors or warnings

2. **Template Generation**
   - Run: `helm template kairoflow helm/kairoflow`
   - Verify all resources are generated correctly

3. **Dry Run Installation**
   - Run: `helm install kairoflow helm/kairoflow --dry-run --debug`
   - Check for configuration errors

4. **Values Override Testing**
   - Test with development values: `helm template kairoflow helm/kairoflow -f helm/kairoflow/values.dev.yaml`
   - Test with production values: `helm template kairoflow helm/kairoflow -f helm/kairoflow/values.prod.yaml`

5. **Deployment Testing**
   - Deploy to test namespace
   - Verify all pods are running
   - Check service connectivity
   - Test ingress routing
   - Verify persistent volume mounts

### Acceptance Testing
- [ ] Helm chart passes linting
- [ ] All templates generate valid Kubernetes manifests
- [ ] Application deploys successfully to namespace
- [ ] PostgreSQL and Redis are accessible from app
- [ ] Ingress routes traffic correctly with HTTPS
- [ ] Health checks respond correctly
- [ ] CronJobs execute on schedule
- [ ] Persistent volumes are mounted and writable
- [ ] Secrets are properly injected as environment variables

## Dependencies
- Story 1.1 must be completed (application with health endpoint)
- Access to Rancher cluster for deployment
- cert-manager installed for TLS certificates
- Default StorageClass configured for PVCs

## Definition of Done
- [ ] All acceptance criteria met
- [ ] Helm chart syntax validated
- [ ] Templates generate valid K8s manifests
- [ ] README with deployment instructions created
- [ ] Values.yaml fully documented
- [ ] Chart tested with dry-run
- [ ] All services defined and configured
- [ ] Persistent volumes configured
- [ ] Secrets template created
- [ ] Ingress with HTTPS configured
- [ ] CronJobs defined
- [ ] Resource limits set appropriately
- [ ] Health probes configured
- [ ] Code committed to repository

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-31 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-31 | 2.0 | Updated with cluster-specific requirements from terap.online project - Traefik IngressRoute, two-container pod pattern, nginx ConfigMap | Bob (Scrum Master) |
| 2025-08-31 | 3.0 | Major revision based on terap.online working example - External DB/Redis, GHCR registry, GitHub Actions CI/CD, proper Docker builds | Winston (Architect) |
| 2025-08-31 | 4.0 | Completed implementation - All tasks completed, created full Helm chart and CI/CD pipeline | James (Developer) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
claude-opus-4-1-20250805 (James - Full Stack Developer)

### Debug Log References
No debug issues encountered during implementation

### Completion Notes List
- Created complete Helm chart structure with all required templates
- Configured two-container pod pattern (nginx + php-fpm) following terap.online pattern
- Implemented all secret templates for external services (DB, Redis, MinIO, OpenAI)
- Created Traefik IngressRoute for the cluster's ingress controller
- Configured all 4 persistent volumes with proper mount points
- Created comprehensive deployment documentation in helm/kairoflow/README.md
- Built GitHub Actions CI/CD pipeline for automated Docker builds and deployments
- Created Docker build files with proper PHP 8.4 and nginx configurations
- All configurations use external managed services (no in-cluster DB/Redis)

### File List
- helm/kairoflow/Chart.yaml
- helm/kairoflow/values.yaml
- helm/kairoflow/README.md
- helm/kairoflow/templates/_helpers.tpl
- helm/kairoflow/templates/namespace.yaml
- helm/kairoflow/templates/web-app-deployment.yaml
- helm/kairoflow/templates/web-app-service.yaml
- helm/kairoflow/templates/service-account.yaml
- helm/kairoflow/templates/database-secret.yaml
- helm/kairoflow/templates/redis-secret.yaml
- helm/kairoflow/templates/minio-secret.yaml
- helm/kairoflow/templates/openai-secret.yaml
- helm/kairoflow/templates/app-secret.yaml
- helm/kairoflow/templates/ghcr-secret.yaml
- helm/kairoflow/templates/ingressroute.yaml
- helm/kairoflow/templates/certificate.yaml
- helm/kairoflow/templates/nginx-config.yaml
- helm/kairoflow/templates/pvc-uploads.yaml
- helm/kairoflow/templates/pvc-sessions.yaml
- helm/kairoflow/templates/pvc-recordings.yaml
- helm/kairoflow/templates/pvc-transcriptions.yaml
- helm/kairoflow/templates/cronjob-email-processor.yaml
- .github/workflows/docker-build.yml
- docker/php/Dockerfile
- docker/php/php.ini
- docker/php/php-fpm.conf
- docker/nginx/Dockerfile
- docker/nginx/nginx.conf
- docker/nginx/default.conf

## QA Results
*To be populated after QA review*