# Epic 1 - Story 1.2: Kubernetes Deployment Configuration

## Epic Reference
Epic 1: Project Foundation & Authentication

## Priority
P0 (Critical - Foundation)

## Status
Draft

## Story
**As a** DevOps engineer,
**I want** to create Helm charts for the application,
**so that** I can deploy to the Rancher cluster reliably

## Acceptance Criteria
1. Helm chart created with configurable values.yaml
2. Deployment includes app container, PostgreSQL, and Redis
3. Ingress configured with HTTPS termination
4. Persistent volumes for database and file storage
5. Liveness and readiness probes configured to /health
6. Secrets management for sensitive configurations
7. Successfully deploys to K8s namespace

## Tasks / Subtasks
- [ ] Create Helm chart structure (AC: 1)
  - [ ] Initialize Helm chart directory at `helm/kairoflow/`
  - [ ] Create Chart.yaml with chart metadata (version 0.1.0, appVersion 1.0.0)
  - [ ] Create values.yaml with configurable parameters
  - [ ] Create templates directory structure
- [ ] Configure application deployment (AC: 2, 5)
  - [ ] Create deployment.yaml template for KairoFlow app
  - [ ] Define container specs with php:8.4-fpm-alpine image
  - [ ] Configure environment variables from secrets
  - [ ] Set resource requests (256Mi memory, 250m CPU) and limits (512Mi memory, 500m CPU)
  - [ ] Add liveness probe to /health endpoint (initialDelay: 30s, period: 10s)
  - [ ] Add readiness probe to /health endpoint (initialDelay: 5s, period: 5s)
  - [ ] Configure rolling update strategy (maxSurge: 1, maxUnavailable: 0)
- [ ] Set up PostgreSQL deployment (AC: 2, 4)
  - [ ] Create postgres-deployment.yaml template
  - [ ] Use postgres:14-alpine image
  - [ ] Configure PersistentVolumeClaim for database storage (10Gi)
  - [ ] Set up PostgreSQL service for internal communication
  - [ ] Configure environment variables (POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD)
- [ ] Set up Redis deployment (AC: 2, 4)
  - [ ] Create redis-deployment.yaml template
  - [ ] Use redis:7-alpine image
  - [ ] Configure PersistentVolumeClaim for Redis data (2Gi)
  - [ ] Set up Redis service for internal communication
  - [ ] Configure Redis persistence (AOF enabled)
- [ ] Configure Ingress (AC: 3)
  - [ ] Create ingress.yaml template
  - [ ] Configure HTTPS termination with cert-manager annotations
  - [ ] Set up routing rules for KairoFlow application
  - [ ] Add security headers via annotations
  - [ ] Configure rate limiting annotations
- [ ] Implement secrets management (AC: 6)
  - [ ] Create secrets.yaml template for sensitive data
  - [ ] Define database connection secrets (DATABASE_DSN, DATABASE_USER, DATABASE_PASSWORD)
  - [ ] Define Redis connection secrets (REDIS_HOST, REDIS_PORT, REDIS_PASSWORD)
  - [ ] Define application secrets (APP_SECRET, JWT_SECRET)
  - [ ] Add instructions for secret creation in README
- [ ] Configure persistent volumes (AC: 4)
  - [ ] Create pvc.yaml for file uploads storage (5Gi)
  - [ ] Mount volume to /app/public/uploads in app container
  - [ ] Create separate PVCs for PostgreSQL and Redis data
  - [ ] Configure storage class annotations
- [ ] Create service definitions (AC: 2, 5)
  - [ ] Create service.yaml for KairoFlow app (ClusterIP, port 80)
  - [ ] Create postgres-service.yaml (ClusterIP, port 5432)
  - [ ] Create redis-service.yaml (ClusterIP, port 6379)
  - [ ] Configure service selectors and ports
- [ ] Add CronJob configurations (AC: 2)
  - [ ] Create cronjob-email-processor.yaml template
  - [ ] Schedule: "*/1 * * * *" (every minute)
  - [ ] Command: ["php", "bin/console", "app:email:process"]
  - [ ] Set concurrencyPolicy: Forbid
  - [ ] Configure activeDeadlineSeconds: 50
  - [ ] Add resource limits (128Mi request, 256Mi limit)
- [ ] Configure namespace and RBAC (AC: 7)
  - [ ] Create namespace.yaml template
  - [ ] Add namespace: kairoflow
  - [ ] Create ServiceAccount if needed
  - [ ] Configure necessary RBAC rules
- [ ] Create Helm values configuration (AC: 1)
  - [ ] Define image repository and tag values
  - [ ] Configure replica counts
  - [ ] Set resource limits as configurable values
  - [ ] Define ingress host and TLS settings
  - [ ] Configure database and Redis connection parameters
  - [ ] Add environment-specific overrides (dev, staging, prod)
- [ ] Write deployment documentation (AC: 7)
  - [ ] Create helm/kairoflow/README.md
  - [ ] Document Helm installation commands
  - [ ] Document upgrade and rollback procedures
  - [ ] List all configurable values
  - [ ] Add troubleshooting section
  - [ ] Include secret management instructions
- [ ] Test Helm chart locally (AC: 7)
  - [ ] Validate chart syntax: `helm lint helm/kairoflow`
  - [ ] Generate manifests: `helm template kairoflow helm/kairoflow`
  - [ ] Test installation with dry-run: `helm install kairoflow helm/kairoflow --dry-run`
  - [ ] Document test results

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 - Project Setup & Repository Initialization]
- Health check endpoint will be available at /health returning 200 OK with system status
- Application uses Nette Framework with PHP 8.4+
- Database configuration uses environment variables: DATABASE_DSN, DATABASE_USER, DATABASE_PASSWORD
- Redis configuration uses: REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
- Docker base image: php:8.4-fpm-alpine with required extensions

### Kubernetes Architecture
[Source: architecture/6-kubernetes-deployment.md]

**Deployment Strategy:**
- Namespace: kairoflow
- Replica count: 2 for high availability
- Rolling update strategy with maxSurge: 1, maxUnavailable: 0
- Resource requests: 256Mi memory, 250m CPU
- Resource limits: 512Mi memory, 500m CPU

**Health Checks:**
- Liveness probe: HTTP GET /health, initialDelay: 30s, period: 10s
- Readiness probe: HTTP GET /ready, initialDelay: 5s, period: 5s

**CronJob Configuration:**
- Email processor runs every minute
- ConcurrencyPolicy: Forbid (prevent overlapping runs)
- ActiveDeadlineSeconds: 50 (kill if runs > 50 seconds)
- Command: ["php", "bin/console", "email:process"]

### Helm Chart Structure
[Source: architecture/source-tree.md]

Expected Helm chart location:
```
helm/
└── kairoflow/
    ├── Chart.yaml
    ├── values.yaml
    ├── templates/
    │   ├── namespace.yaml
    │   ├── deployment.yaml
    │   ├── service.yaml
    │   ├── ingress.yaml
    │   ├── secrets.yaml
    │   ├── pvc.yaml
    │   ├── postgres-deployment.yaml
    │   ├── postgres-service.yaml
    │   ├── redis-deployment.yaml
    │   ├── redis-service.yaml
    │   └── cronjob-email-processor.yaml
    └── README.md
```

### Container Configuration
[Source: architecture/tech-stack.md#orchestration]

**Kubernetes & Helm:**
- Kubernetes 1.28+ with Helm 3.x
- Rancher 2 for K8s management
- Base image: php:8.4-fpm-alpine
- Multi-stage builds for smaller images

**Required PHP Extensions:**
- pdo_pgsql (PostgreSQL)
- redis (Redis cache)
- opcache (Performance)
- mbstring (String handling)
- sodium (Encryption)
- intl (Internationalization)
- zip (Archive handling)

### Environment Variables
[Source: architecture/tech-stack.md]

Required environment variables for deployment:
- DATABASE_DSN (e.g., "pgsql:host=postgres;dbname=kairoflow")
- DATABASE_USER (e.g., "kairoflow")
- DATABASE_PASSWORD (secure password)
- REDIS_HOST (e.g., "redis")
- REDIS_PORT (default: 6379)
- REDIS_PASSWORD (optional, if Redis auth enabled)
- NETTE_DEBUG (0 for production)
- NETTE_ENV (production)
- APP_SECRET (Nette application secret)
- JWT_SECRET (for JWT token generation)

### Service Configuration
[Source: architecture/tech-stack.md#docker-configuration]

**PostgreSQL Service:**
- Image: postgres:14-alpine
- Port: 5432
- Environment: POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD
- Storage: 10Gi PersistentVolume

**Redis Service:**
- Image: redis:7-alpine
- Port: 6379
- Configuration: AOF persistence enabled
- Storage: 2Gi PersistentVolume

**Application Service:**
- Port: 80 (nginx + php-fpm)
- Type: ClusterIP
- Exposed via Ingress

### Security Considerations
[Source: architecture/7-security-architecture.md]

**Secret Management:**
- Use Kubernetes Secrets for sensitive data
- Never hardcode credentials in manifests
- Document secret creation process
- Consider using sealed-secrets or external-secrets-operator

**Network Security:**
- HTTPS termination at Ingress
- Security headers via Ingress annotations
- Rate limiting configuration
- Internal services use ClusterIP

### File Storage
[Source: architecture/source-tree.md#public-assets]

**Persistent Volume Mounts:**
- /app/public/uploads - User uploads (5Gi)
  - /app/public/uploads/qr-codes - Generated QR codes
  - /app/public/uploads/attachments - Email attachments

### Performance Targets
[Source: architecture/tech-stack.md#performance-targets]

- Page Load: < 2 seconds (95th percentile)
- API Response: < 200ms (average)
- Email Processing: < 30 seconds per email
- Health check response: < 100ms

### Deployment Commands Reference
[Source: architecture/tech-stack.md]

Console commands to be used in CronJobs:
- `bin/console app:email:process` - Process emails (every minute)
- `bin/console app:invoice:generate` - Generate invoices (weekly)
- `bin/console app:cleanup` - Cleanup old data (daily)
- `bin/console orm:schema:validate` - Validate schema (daily check)

## Testing
[Source: architecture/coding-standards.md#testing-standards]

### Helm Chart Testing
1. **Syntax Validation**
   - Run: `helm lint helm/kairoflow`
   - Expected: No errors or warnings

2. **Template Generation**
   - Run: `helm template kairoflow helm/kairoflow`
   - Verify all resources are generated correctly

3. **Dry Run Installation**
   - Run: `helm install kairoflow helm/kairoflow --dry-run --debug`
   - Check for configuration errors

4. **Values Override Testing**
   - Test with development values: `helm template kairoflow helm/kairoflow -f helm/kairoflow/values.dev.yaml`
   - Test with production values: `helm template kairoflow helm/kairoflow -f helm/kairoflow/values.prod.yaml`

5. **Deployment Testing**
   - Deploy to test namespace
   - Verify all pods are running
   - Check service connectivity
   - Test ingress routing
   - Verify persistent volume mounts

### Acceptance Testing
- [ ] Helm chart passes linting
- [ ] All templates generate valid Kubernetes manifests
- [ ] Application deploys successfully to namespace
- [ ] PostgreSQL and Redis are accessible from app
- [ ] Ingress routes traffic correctly with HTTPS
- [ ] Health checks respond correctly
- [ ] CronJobs execute on schedule
- [ ] Persistent volumes are mounted and writable
- [ ] Secrets are properly injected as environment variables

## Dependencies
- Story 1.1 must be completed (application with health endpoint)
- Access to Rancher cluster for deployment
- cert-manager installed for TLS certificates
- Default StorageClass configured for PVCs

## Definition of Done
- [ ] All acceptance criteria met
- [ ] Helm chart syntax validated
- [ ] Templates generate valid K8s manifests
- [ ] README with deployment instructions created
- [ ] Values.yaml fully documented
- [ ] Chart tested with dry-run
- [ ] All services defined and configured
- [ ] Persistent volumes configured
- [ ] Secrets template created
- [ ] Ingress with HTTPS configured
- [ ] CronJobs defined
- [ ] Resource limits set appropriately
- [ ] Health probes configured
- [ ] Code committed to repository

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-31 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be recorded*

### Debug Log References
*To be recorded*

### Completion Notes List
*To be recorded*

### File List
*To be recorded*

## QA Results
*To be populated after QA review*